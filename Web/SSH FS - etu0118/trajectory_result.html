<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CARGOOO! – Trajectoire</title>

  <!-- Police + feuille globale -->
  <link href="https://fonts.googleapis.com/css2?family=Belanosima:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Mapbox JS (token inclus) -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js?access_token=pk.eyJ1IjoibWVjYWRlYyIsImEiOiJjbWMwa3E3enEwMTY4MmtwajlybTI0cHBvIn0.ViQ5X-5mq08GAYbszceg8A"></script>

  <!-- Modules utilitaires communs -->
  <script type="module" src="../js/utils.js"></script>
  <script type="module" src="../js/api.js"></script>
</head>
<body>
  <!-- ═════ NAVBAR partagée ═════ -->
  <nav class="navbar">
    <a href="index.html"><img src="../assets/LOGO__CARGOOO.png" alt="Logo" class="logo" /></a>
    <ul class="nav-links">
      <li><a href="index.html">Accueil</a></li>
      <li><a href="visualisation.html">Visualisation</a></li>
      <li><a href="ajout.html">Ajout Données</a></li>
      <li><a href="prediction.html">Prédiction</a></li>
    </ul>
  </nav>

  <main id="result-page">
    <h2>Prédiction de trajectoire</h2>

    <div class="form-container" id="map-card">
      <h3 class="mb-3 text-center">Dernière position &amp; trajectoire prévue</h3>

      <!-- Carte -->
      <div id="map" style="width:100%;height:360px;border-radius:10px"></div>

      <!-- Tableau -->
      <table class="table mt-3 mb-0">
        <thead class="table-light">
          <tr>
            <th>Délai</th><th>Latitude</th><th>Longitude</th>
          </tr>
        </thead>
        <tbody id="predTableBody"></tbody>
      </table>

      <div class="text-center mt-4">
        <a href="prediction.html" class="btn btn-outline-primary">&larr; Retour</a>
      </div>
    </div>
  </main>

  <!-- ═════ JS spécifique à la page ═════ -->
  <script type="module">
     mapboxgl.accessToken = 'pk.eyJ1IjoibWVjYWRlYyIsImEiOiJjbWMwa3E3enEwMTY4MmtwajlybTI0cHBvIn0.ViQ5X-5mq08GAYbszceg8A';
    import { showAlert } from '../js/utils.js';
    import { postJSON }  from '../js/api.js';

    /* Identifiants Mapbox */
    const LINE_ID  = 'predLine';
    const POINT_ID = 'predPoints';
    const COLORS   = {5:'#ff0000', 10:'#ffa500', 15:'#ffff00'};

    let map, curMarker;           // objets persistants
    const tbody = document.getElementById('predTableBody');

    /* 1. Récupérer le MMSI de l'URL */
    const mmsi = new URLSearchParams(location.search).get('mmsi');
    if (!mmsi) {
      showAlert('MMSI manquant', 'error');
      throw new Error('No MMSI');
    }

    /* 2. Appel backend + rendu */
    (async function init() {
      try {
        const resp = await postJSON('php/predict.php', { mmsi });
        const obj  = resp.data ?? resp;   // compat enveloppe {success,data:…}
        renderMap(obj);
        renderTable(obj.predictions);
      } catch (err) { showAlert(err.message, 'error'); }
    })();

    /* ───────────────────────────────────────── Helpers */
    function renderTable(preds) {
      tbody.innerHTML = preds.map(p => `
        <tr>
          <td>+${p.minutes} min</td>
          <td>${p.lat.toFixed(5)}</td>
          <td>${p.lon.toFixed(5)}</td>
        </tr>`).join('');
    }

    function renderMap(obj) {
      const [lat, lon] = obj.now;

      /* ── 1. initialisation (une seule fois) ───────────────── */
      if (!map) {
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [lon, lat],
          zoom: 8
        });
        map.addControl(new mapboxgl.NavigationControl());
      } else {
        map.setCenter([lon, lat]);
      }

      /* ── 2. marqueur position actuelle ────────────────────── */
      if (curMarker) curMarker.remove();
      curMarker = new mapboxgl.Marker({ color: '#0067ff' })
        .setLngLat([lon, lat])
        .setPopup(new mapboxgl.Popup().setHTML('Position actuelle'))
        .addTo(map);

      /* ── 3. préparer GeoJSON pour la ligne et les points ──── */
      const coords = [[lon, lat], ...obj.predictions.map(p => [p.lon, p.lat])];

      const geoLine = {
        type: 'Feature',
        geometry: { type: 'LineString', coordinates: coords }
      };

      const geoPoints = {
        type: 'FeatureCollection',
        features: obj.predictions.map(p => ({
          type: 'Feature',
          properties: { minutes: p.minutes },
          geometry: { type: 'Point', coordinates: [p.lon, p.lat] }
        }))
      };

      /* ── 4. mettre à jour / créer sources & couches ───────── */
      map.once('load', () => addLayers());          // premier chargement
      if (map.isStyleLoaded()) addLayers();        // rafraîchissements

      function addLayers() {
        // -------- ligne
        if (map.getSource(LINE_ID)) {
          map.getSource(LINE_ID).setData(geoLine);
        } else {
          map.addSource(LINE_ID, { type: 'geojson', data: geoLine });
          map.addLayer({
            id: LINE_ID,
            type: 'line',
            source: LINE_ID,
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#8338ec', 'line-width': 3 }
          });
        }

        // -------- points
        if (map.getSource(POINT_ID)) {
          map.getSource(POINT_ID).setData(geoPoints);
        } else {
          map.addSource(POINT_ID, { type: 'geojson', data: geoPoints });
          map.addLayer({
            id: POINT_ID,
            type: 'circle',
            source: POINT_ID,
            paint: {
              'circle-radius': 6,
              'circle-color': [
                'match', ['get', 'minutes'],
                5, COLORS[5],
                10, COLORS[10],
                15, COLORS[15],
                /* other */ '#000'
              ],
              'circle-stroke-width': 1,
              'circle-stroke-color': '#000'
            }
          });
        }
      }
    }
  </script>
</body>
</html>
